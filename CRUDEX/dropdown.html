<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Filterable Dropdown</title>
  </head>
  <body>
    <div style="height: 560px"></div>
    <input type="text" placeholder="Input de referência" />
    <filterable-dropdown id="dropdown1"></filterable-dropdown>
    <filterable-dropdown id="dropdown2"></filterable-dropdown>

    <script>
      class FilterableDropdown extends HTMLElement {
        constructor() {
          super();
          this.attachShadow({ mode: "open" });

          this.currentPage = 0;
          this.itemsPerPage = 5;
          this.data = [];
          this.filteredData = [];

          this.shadowRoot.innerHTML = `
          <style>
            :host {
              display: inline-block;
              position: relative;
              font-family: inherit;
            }

            .input-container {
              position: relative;
            }

            .filter-input {
              width: 100%;
              height: 2.8dvmin;
              padding: 0.5dvmin;
              border: 0.1dvmin solid #000;
              border-radius: 0.1dvmin;
              box-sizing: border-box;
              font-family: inherit;
            }

            .dropdown-icon {
              position: absolute;
              top: 50%;
              right: 0.5dvmin;
              transform: translateY(-50%);
              cursor: pointer;
              font-size: 2dvmin;
              color: #888;
              user-select: none;
            }

            .dropdown-list {
              position: absolute;
              top: calc(100% + 0.8dvmin);
              left: 0;
              right: 0;
              max-height: 100dvmin;
              overflow-y: auto;
              background: white;
              display: none;
              box-shadow: 0 0.8dvmin 1.6dvmin rgba(0, 0, 0, 0.2);
              font-family: inherit;
              z-index: 100;
              border: none;
            }

            .dropdown-list.open {
              display: block;
            }

            .dropdown-item {
              padding: 0.5dvmin;
              cursor: pointer;
              font-family: inherit;
            }

            .dropdown-item:hover {
              background-color: #f0f0f0;
            }

            .pagination {
              display: flex;
              justify-content: space-between;
              padding: 0.5dvmin;
              background: #f9f9f9;
            }

            .pagination button {
              border: none;
              background: none;
              cursor: pointer;
              font-size: 2dvmin;
              color: #007bff;
            }

            .pagination button[disabled] {
              color: #ccc;
              cursor: not-allowed;
              pointer-events: none;
            }
          </style>

          <div class="input-container">
            <input type="text" class="filter-input" placeholder="Type to filter..." />
            <span class="dropdown-icon">&#9660;</span>
            <div class="dropdown-list">
              <div class="dropdown-items"></div>
              <div class="pagination">
                <button class="prev-button" disabled>&#9664;</button>
                <button class="next-button">&#9654;</button>
              </div>
            </div>
          </div>
        `;
        }

        connectedCallback() {
          window.addEventListener("dropdownOpened", (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (e.detail.dropdown !== this) {
              this.hideDropdown();
            }
          });
          this.filterInput = this.shadowRoot.querySelector(".filter-input");
          this.dropdownIcon = this.shadowRoot.querySelector(".dropdown-icon");
          this.dropdownList = this.shadowRoot.querySelector(".dropdown-list");
          this.itemsContainer =
            this.shadowRoot.querySelector(".dropdown-items");
          this.prevButton = this.shadowRoot.querySelector(".prev-button");
          this.prevButton.tabIndex = -1;
          this.nextButton = this.shadowRoot.querySelector(".next-button");
          this.nextButton.tabIndex = -1;

          this.filterInput.addEventListener("focus", () => {
            this.filterItems(this.filterInput.value.trim());
            if (this.filterInput.value.trim()) this.showDropdown();
          });

          this.filterInput.addEventListener("input", (e) => {
            this.filterItems(e.target.value.trim());
            this.showDropdown();
          });

          this.filterInput.addEventListener("blur", () => {
            this.hideDropdown();
          });

          this.filterInput.addEventListener("click", (e) => {
            e.stopPropagation();
            if (this.dropdownList.classList.contains("open")) {
              this.hideDropdown();
            } else {
              this.filterItems(this.filterInput.value.trim());
              this.showDropdown();
            }
          });

          this.dropdownIcon.addEventListener("mousedown", (e) => {
            e.preventDefault(); // Impede perda de foco
            this.filterInput.focus(); // Força o foco no input
            this.filterInput.click(); // Simula o clique no input
          });

          this.prevButton.addEventListener("click", () => this.changePage(-1));
          this.nextButton.addEventListener("click", () => this.changePage(1));
          this.dropdownList.addEventListener("mousedown", (e) =>
            e.preventDefault()
          );

          // Gerenciar o foco entre os dropdowns
          document.addEventListener("focusin", (e) =>
            this.handleFocusChange(e)
          );
        }

        disconnectedCallback() {
          document.removeEventListener("focusin", this.handleFocusChange);
          window.removeEventListener("dropdownOpened", (e) => {
            if (e.detail.dropdown !== this) {
              this.hideDropdown();
            }
          });
        }

        set dataSource(items) {
          this.data = items;
          this.filteredData = [...items];
          this.renderItems();
        }

        handleFocusChange(event) {
          if (!this.contains(event.target)) {
            this.hideDropdown();
          }
        }

        filterItems(query) {
          this.filteredData = this.data.filter((item) =>
            item.toLowerCase().includes(query.toLowerCase())
          );
          this.currentPage = 0;
          this.renderItems();
        }

        changePage(direction) {
          const totalPages = Math.ceil(
            this.filteredData.length / this.itemsPerPage
          );
          this.currentPage = Math.min(
            Math.max(this.currentPage + direction, 0),
            totalPages - 1
          );
          this.renderItems();
        }

        renderItems() {
          const start = this.currentPage * this.itemsPerPage;
          const end = start + this.itemsPerPage;

          this.itemsContainer.innerHTML = "";
          const pageItems = this.filteredData.slice(start, end);
          pageItems.forEach((item) => {
            const div = document.createElement("div");
            div.className = "dropdown-item";
            div.textContent = item;
            div.addEventListener("click", () => this.selectItem(item));
            this.itemsContainer.appendChild(div);
          });

          this.updatePagination();

          if (this.filteredData.length === 0) {
            this.hideDropdown();
          }
        }

        updatePagination() {
          const totalPages = Math.ceil(
            this.filteredData.length / this.itemsPerPage
          );
          this.prevButton.disabled = this.currentPage === 0;
          this.nextButton.disabled = this.currentPage >= totalPages - 1;

          const paginationContainer =
            this.shadowRoot.querySelector(".pagination");
          paginationContainer.style.display = totalPages > 1 ? "flex" : "none";
        }

        showDropdown() {
          const event = new CustomEvent("dropdownOpened", {
            detail: { dropdown: this },
            bubbles: true, // Permite a propagação do evento
          });
          window.dispatchEvent(event); // Dispara o evento globalmente

          this.dropdownList.style.visibility = "hidden";
          this.dropdownList.style.display = "block";

          const dropdownRect = this.filterInput.getBoundingClientRect();
          const listHeight = this.dropdownList.scrollHeight;
          const viewportHeight = window.innerHeight;
          const spaceBelow = viewportHeight - dropdownRect.bottom;
          const spaceAbove = dropdownRect.top;

          if (spaceBelow < listHeight && spaceAbove > listHeight) {
            this.dropdownList.style.top = "auto";
            this.dropdownList.style.bottom = `${dropdownRect.height}px`;
          } else {
            this.dropdownList.style.top = `calc(100% + 0.8dvmin)`;
            this.dropdownList.style.bottom = "auto";
          }

          this.dropdownList.style.visibility = "visible";
          this.dropdownList.classList.add("open");
        }

        hideDropdown() {
          this.dropdownList.classList.remove("open");
          this.dropdownList.style.display = "none";
          this.dropdownList.style.top = "";
          this.dropdownList.style.bottom = "";
        }

        selectItem(item) {
          this.filterInput.value = item;
          this.hideDropdown();
        }
      }

      customElements.define("filterable-dropdown", FilterableDropdown);

      const dropdown1 = document.getElementById("dropdown1");
      dropdown1.dataSource = [
        "Apple",
        "Banana",
        "Cherry",
        "Date",
        "Fig",
        "Grape",
        "Kiwi",
      ];
      dropdown1.itemsPerPageCount = 3;

      const dropdown2 = document.getElementById("dropdown2");
      dropdown2.dataSource = [
        "Mango",
        "Orange",
        "Papaya",
        "Pineapple",
        "Strawberry",
        "Watermelon",
      ];
      dropdown2.itemsPerPageCount = 3;
    </script>
  </body>
</html>
