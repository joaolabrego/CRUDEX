<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Filterable Dropdown</title>
  </head>
  <body>
    <filterable-dropdown id="dropdown1"></filterable-dropdown>
    <filterable-dropdown id="dropdown2"></filterable-dropdown>
    <script>
      class FilterableDropdown extends HTMLElement {
        constructor() {
          super();
          this.attachShadow({ mode: "open" });

          this.currentPage = 0;
          this.itemsPerPage = 5; // Default to 5 items per page
          this.data = []; // All dropdown items
          this.filteredData = []; // Data after filtering
          this.isDropdownVisible = false; // Track visibility status

          this.shadowRoot.innerHTML = `
      <style>
        :host {
          display: inline-block;
          font-family: Arial, sans-serif;
          position: relative;
          width: 200px;
        }

        .input-container {
          position: relative;
        }

        .filter-input {
          width: 100%;
          box-sizing: border-box;
          padding: 8px 30px 8px 8px; /* Extra right padding for the icon */
          border: 1px solid #ccc;
          border-radius: 4px;
          outline: none;
        }

        .filter-input:focus {
          border-color: #007bff;
        }

        .dropdown-icon {
          position: absolute;
          top: 50%;
          right: 8px;
          transform: translateY(-50%);
          cursor: pointer;
          font-size: 12px;
          color: #888;
        }

        .dropdown-list {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          max-height: 200px;
          overflow-y: auto;
          border: 1px solid #ccc;
          background: #fff;
          z-index: 10;
          display: none;
        }

        .dropdown-list.open {
          display: block;
        }

        .dropdown-item {
          padding: 8px 10px;
          cursor: pointer;
        }

        .dropdown-item:hover {
          background: #e0e0e0;
        }

        .pagination {
          display: flex;
          justify-content: space-between;
          padding: 5px;
          background: #f9f9f9;
          border-top: 1px solid #ccc;
          display: none; /* Hidden by default */
        }

        .pagination.visible {
          display: flex; /* Show only when there is more than one page */
        }

        .pagination button {
          border: none;
          background: none;
          cursor: pointer;
          color: #007bff;
        }

        .pagination button[disabled] {
          color: #ccc;
          cursor: not-allowed;
          pointer-events: none; /* Prevent interaction with disabled buttons */
        }
      </style>

      <div class="input-container">
        <input type="text" class="filter-input" placeholder="Type to filter...">
        <span class="dropdown-icon" aria-label="Toggle Dropdown">▼</span>
      </div>
      <div class="dropdown-list">
        <div class="dropdown-items"></div>
        <div class="pagination">
          <button class="prev-button" disabled>&laquo; Prev</button>
          <button class="next-button">&raquo; Next</button>
        </div>
      </div>
    `;
        }

        connectedCallback() {
          const filterInput = this.shadowRoot.querySelector(".filter-input");
          const dropdownIcon = this.shadowRoot.querySelector(".dropdown-icon");
          const dropdownList = this.shadowRoot.querySelector(".dropdown-list");
          const prevButton = this.shadowRoot.querySelector(".prev-button");
          const nextButton = this.shadowRoot.querySelector(".next-button");

          // Show the dropdown when clicking the icon
          dropdownIcon.onclick = () => {
            if (!this.isDropdownVisible) {
              this.filteredData = [...this.data];
              this.currentPage = 0;
              this.renderItems();
              this.setDropdownVisibility(true);
            } else {
              this.setDropdownVisibility(false);
            }
          };

          filterInput.onfocus = () => {
            // Exibe a lista ao focar, caso haja valor no input
            if (filterInput.value.trim()) {
              this.filterItems(filterInput.value.trim());
              this.setDropdownVisibility(true);
            }
          };

          filterInput.oninput = (e) => {
            const query = e.target.value.trim();
            if (query) {
              // Exibe a lista se há caracteres no input
              this.filterItems(query);
              this.setDropdownVisibility(true);
            }
          };

          // Always hide the dropdown when the input loses focus, unless interacting with the dropdown
          filterInput.onblur = () => {
            setTimeout(() => {
              if (
                !this.shadowRoot.activeElement ||
                !dropdownList.contains(this.shadowRoot.activeElement)
              ) {
                this.setDropdownVisibility(false);
              }
            }, 100); // Delay to allow clicks on dropdown items
          };

          // Prevent blur when interacting with the dropdown list
          dropdownList.onmousedown = (e) => {
            e.preventDefault();
          };

          // Pagination controls
          prevButton.onclick = () => {
            if (!prevButton.disabled) this.changePage(-1);
          };
          prevButton.tabIndex = -1;

          nextButton.onclick = () => {
            if (!nextButton.disabled) this.changePage(1);
          };
          nextButton.tabIndex = -1;
        }

        set dataSource(items) {
          this.data = items;
          this.filteredData = [...items]; // Initialize filtered data
          this.renderItems();
        }

        set itemsPerPageCount(count) {
          this.itemsPerPage = count;
          this.renderItems();
        }

        filterItems(query) {
          this.currentPage = 0; // Reset to the first page when filtering
          this.filteredData = this.data.filter((item) =>
            item.toLowerCase().includes(query.toLowerCase())
          );
          this.renderItems();
        }

        changePage(direction) {
          const totalPages = Math.ceil(
            this.filteredData.length / this.itemsPerPage
          );
          this.currentPage += direction;

          if (this.currentPage < 0) {
            this.currentPage = 0;
          } else if (this.currentPage >= totalPages) {
            this.currentPage = totalPages - 1;
          }

          this.renderItems();
        }

        renderItems() {
          const itemsContainer =
            this.shadowRoot.querySelector(".dropdown-items");
          itemsContainer.innerHTML = "";

          const start = this.currentPage * this.itemsPerPage;
          const end = start + this.itemsPerPage;

          const pageItems = this.filteredData.slice(start, end);

          pageItems.forEach((item) => {
            const div = document.createElement("div");
            div.className = "dropdown-item";
            div.textContent = item;
            div.onclick = () => this.selectItem(item);
            itemsContainer.appendChild(div);
          });

          this.updatePagination();
        }

        updatePagination() {
          const prevButton = this.shadowRoot.querySelector(".prev-button");
          const nextButton = this.shadowRoot.querySelector(".next-button");
          const paginationContainer =
            this.shadowRoot.querySelector(".pagination");

          const totalPages = Math.ceil(
            this.filteredData.length / this.itemsPerPage
          );

          prevButton.disabled = this.currentPage === 0;
          nextButton.disabled = this.currentPage >= totalPages - 1;

          paginationContainer.classList.toggle("visible", totalPages > 1);
        }

        setDropdownVisibility(visible) {
          const dropdownList = this.shadowRoot.querySelector(".dropdown-list");
          const filterInput = this.shadowRoot.querySelector(".filter-input");

          this.isDropdownVisible = visible;
          dropdownList.classList.toggle("open", visible);

          if (visible) {
            filterInput.focus(); // Mantém o foco no input
          }
        }

        selectItem(item) {
          const filterInput = this.shadowRoot.querySelector(".filter-input");
          filterInput.value = item;
          this.setDropdownVisibility(false);
          this.dispatchEvent(
            new CustomEvent("itemSelected", { detail: { item } })
          );
        }
      }

      customElements.define("filterable-dropdown", FilterableDropdown);
    </script>
    <script>
      const dropdown1 = document.getElementById("dropdown1");
      dropdown1.dataSource = [
        "Apple",
        "Banana",
        "Cherry",
        "Date",
        "Elderberry",
        "Fig",
        "Grape",
        "Honeydew",
        "Kiwi",
        "Lemon",
        "Mango",
        "Nectarine",
      ];
      dropdown1.itemsPerPageCount = 4;

      const dropdown2 = document.getElementById("dropdown2");
      dropdown2.dataSource = [
        "Apple",
        "Banana",
        "Cherry",
        "Date",
        "Elderberry",
        "Fig",
        "Grape",
        "Honeydew",
        "Kiwi",
        "Lemon",
        "Mango",
        "Nectarine",
      ];
      dropdown2.itemsPerPageCount = 4;
    </script>
  </body>
</html>
